


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > VehicleServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">it.wa2.reservationservice.services</a>
</div>

<h1>Coverage Summary for Class: VehicleServiceImpl (it.wa2.reservationservice.services)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">VehicleServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    73.7%
  </span>
  <span class="absValue">
    (14/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    37%
  </span>
  <span class="absValue">
    (34/92)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    55.4%
  </span>
  <span class="absValue">
    (148/267)
  </span>
</td>
</tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$0</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$1</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$10</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$11</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$12</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$13</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$14</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$15</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$16</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$17</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$18</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$19</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$2</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$20</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$3</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$4</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$5</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$6</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$7</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$8</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$$SpringCGLIB$$9</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$getVehicleMaintenances$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$getVehicleNotes$result$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$getVehicleNotes$result$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$getVehicleNotes$result$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$getVehicleNotes$result$4</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$getVehicles$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">VehicleServiceImpl$getVehicles$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    69.2%
  </span>
  <span class="absValue">
    (18/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    37%
  </span>
  <span class="absValue">
    (34/92)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    55.5%
  </span>
  <span class="absValue">
    (152/274)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package it.wa2.reservationservice.services
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper
&nbsp;import com.github.fge.jsonpatch.JsonPatch
&nbsp;import it.wa2.reservationservice.controllers.*
&nbsp;
&nbsp;import it.wa2.reservationservice.dtos.*
&nbsp;
&nbsp;import it.wa2.reservationservice.dtos.MaintenanceDTO
&nbsp;import it.wa2.reservationservice.dtos.NoteDTO
&nbsp;import it.wa2.reservationservice.dtos.VehicleDTO
&nbsp;import it.wa2.reservationservice.dtos.VehicleFiltersDTO
&nbsp;
&nbsp;import it.wa2.reservationservice.entities.*
&nbsp;import it.wa2.reservationservice.repositories.*
&nbsp;import it.wa2.reservationservice.entities.toDTO
&nbsp;import org.slf4j.LoggerFactory
&nbsp;import org.springframework.beans.factory.annotation.Autowired
&nbsp;import org.springframework.context.annotation.Primary
&nbsp;import org.springframework.context.annotation.Profile
&nbsp;import org.springframework.data.domain.Page
&nbsp;import org.springframework.data.domain.Pageable
&nbsp;import org.springframework.data.repository.findByIdOrNull
&nbsp;import org.springframework.http.HttpStatus
&nbsp;import org.springframework.http.ResponseEntity
&nbsp;import org.springframework.stereotype.Service
&nbsp;import org.springframework.transaction.annotation.Transactional
&nbsp;import org.springframework.validation.annotation.Validated
&nbsp;import java.time.LocalDate
&nbsp;import java.time.format.DateTimeFormatter
&nbsp;import javax.sql.DataSource
&nbsp;
&nbsp;
<b class="fc">&nbsp;@Service</b>
&nbsp;@Primary
&nbsp;@Validated
&nbsp;class VehicleServiceImpl(
<b class="fc">&nbsp;    private val vehicleRepository: VehicleRepository,</b>
<b class="fc">&nbsp;    private val maintenanceRepository: MaintenanceRepository,</b>
<b class="fc">&nbsp;    private val noteRepository: NoteRepository,</b>
<b class="fc">&nbsp;    private val carModelRepository: CarModelRepository,</b>
<b class="fc">&nbsp;    private val availabilityRepository: AvailabilityRepository</b>
&nbsp;) : VehicleService {
<b class="fc">&nbsp;    private val logger = LoggerFactory.getLogger(VehicleServiceImpl::class.java)</b>
&nbsp;
&nbsp;    override fun getFilters(): VehicleFiltersDTO {
<b class="fc">&nbsp;        logger.info(&quot;Getting available vehicle filters&quot;)</b>
<b class="fc">&nbsp;        return VehicleFiltersDTO(</b>
<b class="fc">&nbsp;            availabilities = availabilityRepository.findAll().map { it.type }.toMutableList()</b>
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    // ############## GIUSEPPE ##################
&nbsp;
&nbsp;    override fun getVehicleById(vehicleId: Long): VehicleDTO {
<b class="fc">&nbsp;        logger.info(&quot;Getting vehicle with id: $vehicleId&quot;)</b>
<b class="fc">&nbsp;        val vehicle = vehicleRepository.findByIdOrNull(vehicleId)</b>
<b class="fc">&nbsp;            ?: throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
<b class="fc">&nbsp;        logger.debug(&quot;Found vehicle: $vehicle&quot;)</b>
<b class="fc">&nbsp;        return vehicle.toDTO()</b>
&nbsp;    }
&nbsp;
&nbsp;    @Autowired
<b class="nc">&nbsp;        lateinit var dataSource : DataSource</b>
&nbsp;
&nbsp;        override fun addVehicle(vehicleDTO: VehicleDTO): VehicleDTO {
&nbsp;/*        logger.info(&quot;&gt;&gt;&gt; Controller DB: ${dataSource.connection.metaData.url}&quot;)
&nbsp;        logger.info(&quot;&gt;&gt;&gt; Controller DB: ${dataSource.connection.metaData.userName}&quot;)*/
&nbsp;
<b class="fc">&nbsp;        logger.info(&quot;Adding new vehicle with licence plate: ${vehicleDTO.licencePlate}&quot;)</b>
<b class="fc">&nbsp;        val licencePlateVehicle = vehicleRepository.findByLicencePlate(vehicleDTO.licencePlate)</b>
<b class="pc">&nbsp;        if (licencePlateVehicle.isNotEmpty()) {</b>
<b class="nc">&nbsp;            logger.warn(&quot;ADD VEHICLE - Vehicle with licence plate ${vehicleDTO.licencePlate} already exists : ${licencePlateVehicle[0].id}&quot;)</b>
<b class="nc">&nbsp;            throw VehicleDuplication(&quot;ADD VEHICLE - Licence plate already exists&quot;)</b>
&nbsp;        }
<b class="pc">&nbsp;        val carModel = carModelRepository.findByIdOrNull(vehicleDTO.refCarModel)</b>
<b class="nc">&nbsp;            ?: run {</b>
<b class="nc">&nbsp;                logger.warn(&quot;Car model with id ${vehicleDTO.refCarModel} not found&quot;)</b>
<b class="nc">&nbsp;                throw CarModelNotFound(&quot;Car model not found&quot;)</b>
&nbsp;            }
&nbsp;
&nbsp;        //val availability = availabilityRepository.findByIdOrNull(vehicleDTO.refAvailability)
&nbsp;        //if (!availabilityRepository.existsByType(vehicleDTO.availability)) throw AvailabilityNotFound(&quot;Availability not found&quot;)
<b class="pc">&nbsp;        val availability = availabilityRepository.findByType(vehicleDTO.availability)</b>
<b class="nc">&nbsp;            ?: run {</b>
<b class="nc">&nbsp;                logger.warn(&quot;Availability type ${vehicleDTO.availability} not found&quot;)</b>
<b class="nc">&nbsp;                throw AvailabilityNotFound(&quot;Availability not found&quot;)</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;        val newVehicle = Vehicle(</b>
<b class="fc">&nbsp;            refCarModel = carModel,</b>
<b class="fc">&nbsp;            refAvailability = availability,</b>
<b class="fc">&nbsp;            licencePlate = vehicleDTO.licencePlate,</b>
<b class="fc">&nbsp;            vin = vehicleDTO.vin,</b>
<b class="fc">&nbsp;            kilometers = vehicleDTO.kilometers,</b>
<b class="fc">&nbsp;            pendingCleaning = vehicleDTO.pendingCleaning,</b>
<b class="fc">&nbsp;            pendingMaintenance = vehicleDTO.pendingMaintenance,</b>
&nbsp;        )
&nbsp;
<b class="fc">&nbsp;        val savedVehicle = vehicleRepository.save(newVehicle)</b>
&nbsp;
<b class="fc">&nbsp;        logger.info(&quot;Vehicle saved successfully with id: ${savedVehicle.id}&quot;)</b>
<b class="fc">&nbsp;        logger.debug(&quot;Saved vehicle details: $savedVehicle&quot;)</b>
&nbsp;
<b class="fc">&nbsp;        return savedVehicle.toDTO()</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun modifyVehicle(vehicleId: Long, vehicleDTO: VehicleDTO) {
<b class="fc">&nbsp;        logger.info(&quot;Modifying vehicle with id: $vehicleId&quot;)</b>
&nbsp;
<b class="pc">&nbsp;        val vehicle = vehicleRepository.findByIdOrNull(vehicleId)</b>
<b class="nc">&nbsp;            ?: run {</b>
<b class="nc">&nbsp;                logger.warn(&quot;Vehicle with id $vehicleId not found&quot;)</b>
<b class="nc">&nbsp;                throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
&nbsp;            }
&nbsp;
<b class="pc">&nbsp;        val carModel = carModelRepository.findByIdOrNull(vehicleDTO.refCarModel)</b>
<b class="nc">&nbsp;            ?: run {</b>
<b class="nc">&nbsp;                logger.warn(&quot;Car model with id ${vehicleDTO.refCarModel} not found&quot;)</b>
<b class="nc">&nbsp;                throw CarModelNotFound(&quot;Car model not found&quot;)</b>
&nbsp;            }
&nbsp;
&nbsp;        /*val availability = availabilityRepository.findByIdOrNull(vehicleDTO.refAvailability)
&nbsp;            ?: throw AvailabilityNotFound(&quot;Availability not found&quot;)*/
<b class="pc">&nbsp;        val availability = availabilityRepository.findByType(vehicleDTO.availability)</b>
<b class="nc">&nbsp;            ?: run {</b>
<b class="nc">&nbsp;                logger.warn(&quot;Availability type ${vehicleDTO.availability} not found&quot;)</b>
<b class="nc">&nbsp;                throw AvailabilityNotFound(&quot;Availability not found&quot;)</b>
&nbsp;            }
&nbsp;
&nbsp;        // non capisco perchè questo controllo non funziona -&gt; ho aggiunto quello sotto
&nbsp;       /* if(vehicleRepository.existsByLicencePlate(vehicleDTO.licencePlate)) {
&nbsp;            throw VehicleDuplication(&quot;Licence plate already exists&quot;)
&nbsp;        }*/
&nbsp;
&nbsp;        // ritorna una list di vehicles
<b class="fc">&nbsp;        val vehiclesList = vehicleRepository.findByLicencePlate(vehicleDTO.licencePlate)</b>
<b class="pc">&nbsp;        if (vehiclesList.size != 1) {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Multiple vehicles found with same licence plate: ${vehicleDTO.licencePlate}&quot;)</b>
<b class="nc">&nbsp;            throw VehicleDuplication(&quot;Review the request, we have more than one vehicle with the same license plate&quot;)</b>
&nbsp;        } else {
<b class="pc">&nbsp;            if (vehiclesList[0].id != vehicleId) {</b>
<b class="nc">&nbsp;                logger.warn(&quot;UPDATE VEHICLE - Attempted to update vehicle ${vehicleId} with duplicate licence plate ${vehicleDTO.licencePlate}&quot;)</b>
<b class="nc">&nbsp;                throw VehicleDuplication(&quot;UPDATE VEHICLE - Licence plate already exists&quot;)</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        val updatedVehicle = Vehicle(</b>
<b class="fc">&nbsp;            id = vehicle.id,</b>
<b class="fc">&nbsp;            refCarModel = carModel,</b>
<b class="fc">&nbsp;            refAvailability = availability,</b>
<b class="fc">&nbsp;            licencePlate = vehicleDTO.licencePlate,</b>
<b class="fc">&nbsp;            vin = vehicleDTO.vin,</b>
<b class="fc">&nbsp;            kilometers = vehicleDTO.kilometers,</b>
<b class="fc">&nbsp;            pendingCleaning = vehicleDTO.pendingCleaning,</b>
<b class="fc">&nbsp;            pendingMaintenance = vehicleDTO.pendingMaintenance</b>
&nbsp;        )
&nbsp;
<b class="fc">&nbsp;        vehicleRepository.save(updatedVehicle)</b>
&nbsp;
<b class="fc">&nbsp;        logger.info(&quot;Successfully updated vehicle with id: ${updatedVehicle.id}&quot;)</b>
<b class="fc">&nbsp;        logger.debug(&quot;Updated vehicle details: $updatedVehicle&quot;)</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun deleteVehicleById(vehicleId: Long) {
<b class="fc">&nbsp;        logger.info(&quot;Deleting vehicle with id: $vehicleId&quot;)</b>
&nbsp;
<b class="pc">&nbsp;        vehicleRepository.findByIdOrNull(vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id $vehicleId not found&quot;)</b>
<b class="fc">&nbsp;            throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        vehicleRepository.deleteById(vehicleId)</b>
&nbsp;
<b class="fc">&nbsp;        logger.info(&quot;Successfully deleted vehicle with id: $vehicleId&quot;)</b>
&nbsp;    }
&nbsp;
&nbsp;    // #############################
&nbsp;
&nbsp;    override fun modifyVehicleMaintenance(vehicleId: Long, maintenanceDTO: MaintenanceDTO) {
<b class="fc">&nbsp;        logger.info(&quot;Modifying maintenance for vehicle with id: $vehicleId&quot;)</b>
&nbsp;
<b class="pc">&nbsp;        val vehicle = vehicleRepository.findByIdOrNull(vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id $vehicleId not found&quot;)</b>
<b class="fc">&nbsp;            throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        vehicleRepository.findByIdOrNull(maintenanceDTO.vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id ${maintenanceDTO.vehicleId} not found&quot;)</b>
<b class="fc">&nbsp;            throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (maintenanceDTO.vehicleId != vehicleId) {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle ID mismatch: expected $vehicleId but got ${maintenanceDTO.vehicleId}&quot;)</b>
<b class="nc">&nbsp;            throw VehicleIdInconsistent(&quot;VehicleId are inconsistent&quot;)</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        val maintenanceToUpdate = maintenanceRepository.findByIdOrNull(maintenanceDTO.id)</b>
<b class="nc">&nbsp;            ?: run {</b>
<b class="nc">&nbsp;                logger.warn(&quot;Maintenance with id ${maintenanceDTO.id} not found&quot;)</b>
<b class="nc">&nbsp;                throw MaintenanceNotFound(&quot;Maintenance not found&quot;)</b>
&nbsp;            }
&nbsp;
<b class="pc">&nbsp;        if (maintenanceToUpdate.vehicle.id != vehicleId) {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Maintenance ${maintenanceDTO.id} not found for vehicle $vehicleId&quot;)</b>
<b class="nc">&nbsp;            throw MaintenanceNotFound(&quot;Maintenance not found for the specified vehicle&quot;)</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        val parsedDate = maintenanceDTO.date?.let { LocalDate.parse(it, DateTimeFormatter.ISO_LOCAL_DATE) }</b>
&nbsp;
<b class="fc">&nbsp;        val newMaintenance = MaintenanceHistory(</b>
<b class="fc">&nbsp;            maintenanceToUpdate.id,</b>
<b class="fc">&nbsp;            vehicle,</b>
<b class="fc">&nbsp;            maintenanceDTO.defect,</b>
<b class="fc">&nbsp;            maintenanceDTO.completedMaintenance,</b>
<b class="fc">&nbsp;            parsedDate</b>
&nbsp;        )
&nbsp;
<b class="fc">&nbsp;        maintenanceRepository.save(newMaintenance)</b>
<b class="fc">&nbsp;        logger.info(&quot;Successfully updated maintenance ${maintenanceDTO.id} for vehicle $vehicleId&quot;)</b>
<b class="fc">&nbsp;        logger.debug(&quot;Updated maintenance details: $newMaintenance&quot;)</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun getVehicleNotes(
&nbsp;        vehicleId: Long,
&nbsp;        pageable: Pageable,
&nbsp;        startDate: LocalDate?,
&nbsp;        endDate: LocalDate?,
&nbsp;        author: String?
&nbsp;    ): Page&lt;NoteDTO&gt; {
<b class="fc">&nbsp;        logger.info(&quot;Getting notes for vehicle $vehicleId with filters - startDate: $startDate, endDate: $endDate, author: $author&quot;)</b>
&nbsp;
<b class="pc">&nbsp;        val vehicle = vehicleRepository.findByIdOrNull(vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id $vehicleId not found&quot;)</b>
<b class="fc">&nbsp;            throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        val result = if (startDate != null &amp;&amp; endDate != null &amp;&amp; author == null) {</b>
<b class="nc">&nbsp;            noteRepository.findAllByVehicleAndDateBetween(vehicle, startDate, endDate, pageable)</b>
<b class="nc">&nbsp;                .map { it.toDto() }</b>
<b class="pc">&nbsp;        } else if (startDate != null &amp;&amp; endDate != null &amp;&amp; author != null) {</b>
<b class="nc">&nbsp;            noteRepository.findAllByVehicleAndDateBetweenAndAuthorContainsIgnoreCase(</b>
<b class="nc">&nbsp;                vehicle, startDate, endDate, author, pageable</b>
<b class="nc">&nbsp;            ).map { it.toDto() }</b>
<b class="pc">&nbsp;        } else if (startDate == null &amp;&amp; endDate == null &amp;&amp; author != null) {</b>
<b class="nc">&nbsp;            noteRepository.findAllByVehicleAndAuthorContainsIgnoreCase(vehicle, author, pageable)</b>
<b class="nc">&nbsp;                .map { it.toDto() }</b>
&nbsp;        } else {
<b class="fc">&nbsp;            noteRepository.findAllByVehicle(vehicle, pageable).map { it.toDto() }</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        logger.debug(&quot;Found ${result.totalElements} notes&quot;)</b>
<b class="fc">&nbsp;        return result</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun addVehicleNote(vehicleId: Long, noteDTO: NoteDTO): NoteDTO {
<b class="fc">&nbsp;        logger.info(&quot;Adding new note for vehicle $vehicleId&quot;)</b>
&nbsp;
<b class="pc">&nbsp;        val vehicle = vehicleRepository.findByIdOrNull(vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id $vehicleId not found&quot;)</b>
<b class="fc">&nbsp;            throw VehicleNotFound(&quot;Vehicle not found: ${vehicleId}&quot;)</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        vehicleRepository.findByIdOrNull(noteDTO.vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id ${noteDTO.vehicleId} not found&quot;)</b>
<b class="fc">&nbsp;            throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (noteDTO.vehicleId != vehicleId) {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle ID mismatch: expected $vehicleId but got ${noteDTO.vehicleId}&quot;)</b>
<b class="nc">&nbsp;            throw VehicleIdInconsistent(&quot;VehicleId are inconsistent&quot;)</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (noteRepository.existsNoteByTextAndVehicleId(noteDTO.text, vehicleId)) {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Duplicate note text found for vehicle $vehicleId&quot;)</b>
<b class="nc">&nbsp;            throw DuplicatedNote(&quot;Note already exists for this vehicle&quot;)</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        val parsedDate = LocalDate.parse(noteDTO.date, DateTimeFormatter.ISO_LOCAL_DATE)</b>
&nbsp;
&nbsp;        //controllare se l&#39;id viene gestito bene nel db
&nbsp;        //idea: the note id will be 0/null and the db will create a new entry
<b class="fc">&nbsp;        val noteToAdd = Note(vehicle = vehicle, text = noteDTO.text, author = noteDTO.author, date = parsedDate)</b>
<b class="fc">&nbsp;        val savedNote = noteRepository.save(noteToAdd)</b>
&nbsp;
<b class="fc">&nbsp;        logger.info(&quot;Successfully added note for vehicle $vehicleId&quot;)</b>
<b class="fc">&nbsp;        logger.debug(&quot;Added note details: $savedNote&quot;)</b>
&nbsp;
<b class="fc">&nbsp;        return savedNote.toDto()</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun getVehicles(
&nbsp;        pageable: Pageable,
&nbsp;        refCarModel: Long?,
&nbsp;        availability: String?,
&nbsp;        licencePlate: String?,
&nbsp;        vin: String?,
&nbsp;        kilometers: Float?,
&nbsp;        pendingCleaning: Boolean?,
&nbsp;        pendingMaintenance: Boolean?
&nbsp;    ): Page&lt;VehicleDTO&gt; {
<b class="fc">&nbsp;        logger.info(</b>
<b class="fc">&nbsp;            &quot;Getting vehicles with filters - carModel: $refCarModel, availability: $availability, &quot; +</b>
<b class="fc">&nbsp;                    &quot;licencePlate: $licencePlate, vin: $vin, kilometers: $kilometers, &quot; +</b>
<b class="fc">&nbsp;                    &quot;pendingCleaning: $pendingCleaning, pendingMaintenance: $pendingMaintenance&quot;</b>
&nbsp;        )
&nbsp;
<b class="fc">&nbsp;        if (refCarModel != null) {</b>
<b class="pc">&nbsp;            val carModel = carModelRepository.findByIdOrNull(refCarModel) ?: run {</b>
<b class="nc">&nbsp;                logger.warn(&quot;Car model with id $refCarModel not found&quot;)</b>
<b class="fc">&nbsp;                throw VehicleNotFound(&quot;Car model not found&quot;)</b>
&nbsp;            }
<b class="fc">&nbsp;            return vehicleRepository.findWithFilters(</b>
<b class="fc">&nbsp;                pageable, carModel, availability, licencePlate,</b>
<b class="fc">&nbsp;                vin, kilometers, pendingCleaning, pendingMaintenance</b>
&nbsp;            )
<b class="fc">&nbsp;                .map { it.toDTO() }</b>
&nbsp;        }
<b class="fc">&nbsp;        return vehicleRepository.findWithFilters(</b>
<b class="fc">&nbsp;            pageable, null, availability, licencePlate,</b>
<b class="fc">&nbsp;            vin, kilometers, pendingCleaning, pendingMaintenance</b>
&nbsp;        )
<b class="fc">&nbsp;            .map { it.toDTO() }</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    override fun modifyVehicleNote(vehicleId: Long, noteId: Long, noteDTO: NoteDTO) {
<b class="nc">&nbsp;        logger.info(&quot;Modifying note $noteId for vehicle $vehicleId&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        val vehicle = vehicleRepository.findByIdOrNull(vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id $vehicleId not found&quot;)</b>
<b class="nc">&nbsp;            throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        vehicleRepository.findByIdOrNull(noteDTO.vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id ${noteDTO.vehicleId} not found&quot;)</b>
<b class="nc">&nbsp;            throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (noteDTO.vehicleId != vehicleId) {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle ID mismatch: expected $vehicleId but got ${noteDTO.vehicleId}&quot;)</b>
<b class="nc">&nbsp;            throw VehicleIdInconsistent(&quot;VehicleId are inconsistent&quot;)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val noteToUpdate = noteRepository.findByIdOrNull(noteId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Note with id $noteId not found&quot;)</b>
<b class="nc">&nbsp;            throw NoteNotFound(&quot;Note not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (noteToUpdate.vehicle.id != vehicleId) {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Note $noteId not found for vehicle $vehicleId&quot;)</b>
<b class="nc">&nbsp;            throw NoteNotFound(&quot;Note not found for the specified vehicle&quot;)</b>
&nbsp;        }
&nbsp;
&nbsp;        /*if(noteRepository.existsNoteByTextAndVehicleId(noteDTO.text, vehicleId)){
&nbsp;            throw DuplicatedNote(&quot;Note already exists for this vehicle&quot;)
&nbsp;        }*/
<b class="nc">&nbsp;        val parsedDate = LocalDate.parse(noteDTO.date, DateTimeFormatter.ISO_LOCAL_DATE)</b>
&nbsp;
&nbsp;        //I create a new note instead of modify the old one
<b class="nc">&nbsp;        val newNote = Note(</b>
<b class="nc">&nbsp;            noteToUpdate.id,</b>
<b class="nc">&nbsp;            vehicle,</b>
<b class="nc">&nbsp;            noteDTO.text,</b>
<b class="nc">&nbsp;            noteDTO.author,</b>
<b class="nc">&nbsp;            parsedDate</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        noteRepository.save(newNote)</b>
&nbsp;
<b class="nc">&nbsp;        logger.info(&quot;Successfully updated note $noteId for vehicle $vehicleId&quot;)</b>
<b class="nc">&nbsp;        logger.debug(&quot;Updated note details: $newNote&quot;)</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun deleteVehicleNote(vehicleId: Long, noteId: Long) {
<b class="nc">&nbsp;        logger.info(&quot;Deleting note $noteId from vehicle $vehicleId&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        vehicleRepository.findByIdOrNull(vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id $vehicleId not found&quot;)</b>
<b class="nc">&nbsp;            throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        noteRepository.findByIdOrNull(noteId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Note with id $noteId not found&quot;)</b>
<b class="nc">&nbsp;            throw NoteNotFound(&quot;Note not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        noteRepository.deleteById(noteId)</b>
&nbsp;
<b class="nc">&nbsp;        logger.info(&quot;Successfully deleted note $noteId from vehicle $vehicleId&quot;)</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun patchVehicleById(carId: Long, patch: JsonPatch): ResponseEntity&lt;VehicleDTO&gt; {
<b class="nc">&nbsp;        logger.info(&quot;Applying patch to vehicle $carId&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        val existingVehicle = vehicleRepository.findByIdOrNull(carId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id $carId not found&quot;)</b>
<b class="nc">&nbsp;            throw VehicleNotFound(&quot;Vehicle not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return try {</b>
<b class="nc">&nbsp;            val patchedVehicleDTO = applyPatchToVehicle(patch, existingVehicle.toDTO())</b>
&nbsp;
<b class="nc">&nbsp;            val carModel = carModelRepository.findByIdOrNull(patchedVehicleDTO.refCarModel) ?: run {</b>
<b class="nc">&nbsp;                logger.warn(&quot;Car model with id ${patchedVehicleDTO.refCarModel} not found&quot;)</b>
<b class="nc">&nbsp;                throw CarModelNotFound(&quot;Car model not found&quot;)</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            val availability = availabilityRepository.findByType(patchedVehicleDTO.availability) ?: run {</b>
<b class="nc">&nbsp;                logger.warn(&quot;Availability type ${patchedVehicleDTO.availability} not found&quot;)</b>
<b class="nc">&nbsp;                throw AvailabilityNotFound(&quot;Availability not found&quot;)</b>
&nbsp;            }
&nbsp;
&nbsp;            // ✨ Modifica l&#39;oggetto esistente invece di crearne uno nuovo
<b class="nc">&nbsp;            existingVehicle.apply {</b>
<b class="nc">&nbsp;                refCarModel = carModel</b>
<b class="nc">&nbsp;                refAvailability = availability</b>
<b class="nc">&nbsp;                licencePlate = patchedVehicleDTO.licencePlate</b>
<b class="nc">&nbsp;                vin = patchedVehicleDTO.vin</b>
<b class="nc">&nbsp;                kilometers = patchedVehicleDTO.kilometers</b>
<b class="nc">&nbsp;                pendingCleaning = patchedVehicleDTO.pendingCleaning</b>
<b class="nc">&nbsp;                pendingMaintenance = patchedVehicleDTO.pendingMaintenance</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            // ✨ Salva l&#39;oggetto aggiornato
<b class="nc">&nbsp;            vehicleRepository.save(existingVehicle)</b>
<b class="nc">&nbsp;            logger.info(&quot;Successfully patched vehicle $carId&quot;)</b>
<b class="nc">&nbsp;            logger.debug(&quot;Updated vehicle details: $existingVehicle&quot;)</b>
&nbsp;
<b class="nc">&nbsp;            ResponseEntity.ok(existingVehicle.toDTO())</b>
<b class="nc">&nbsp;        } catch (e: Exception) {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Error patching vehicle $carId: ${e.message}&quot;, e)</b>
<b class="nc">&nbsp;            ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun applyPatchToVehicle(patch: JsonPatch, target: VehicleDTO): VehicleDTO {
<b class="nc">&nbsp;        logger.debug(&quot;Applying JSON patch to vehicle&quot;)</b>
<b class="nc">&nbsp;        val mapper = ObjectMapper()</b>
<b class="nc">&nbsp;        val targetNode: JsonNode = mapper.convertValue(target, JsonNode::class.java)</b>
<b class="nc">&nbsp;        val patchedNode: JsonNode = patch.apply(targetNode)</b>
<b class="nc">&nbsp;        return mapper.treeToValue(patchedNode, VehicleDTO::class.java)</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun getVehicleMaintenances(
&nbsp;        pageable: Pageable,
&nbsp;        vehicleId: Long,
&nbsp;        vehicleLicencePlate: String?,
&nbsp;        defect: String?,
&nbsp;        completedMaintenance: Boolean?,
&nbsp;        date: String?
&nbsp;    ): Page&lt;MaintenanceDTO&gt; {
<b class="fc">&nbsp;        logger.info(</b>
<b class="fc">&nbsp;            &quot;Getting maintenances for vehicle $vehicleId with filters - &quot; +</b>
<b class="fc">&nbsp;                    &quot;licencePlate: $vehicleLicencePlate, defect: $defect, &quot; +</b>
<b class="fc">&nbsp;                    &quot;completedMaintenance: $completedMaintenance, date: $date&quot;</b>
&nbsp;        )
&nbsp;
<b class="fc">&nbsp;        val maintenancesList = maintenanceRepository.findWithFilters(</b>
<b class="fc">&nbsp;            pageable,</b>
<b class="fc">&nbsp;            vehicleId,</b>
<b class="fc">&nbsp;            vehicleLicencePlate,</b>
<b class="fc">&nbsp;            defect,</b>
<b class="fc">&nbsp;            completedMaintenance,</b>
<b class="fc">&nbsp;            date</b>
&nbsp;        )
<b class="fc">&nbsp;        logger.debug(&quot;Found ${maintenancesList.totalElements} maintenance records&quot;)</b>
<b class="fc">&nbsp;        return maintenancesList.map { it.toDTO() }</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    override fun getVehicleMaintenanceById(vehicleId: Long, maintenanceId: Long): MaintenanceDTO {
<b class="fc">&nbsp;        logger.info(&quot;Getting maintenance $maintenanceId for vehicle $vehicleId&quot;)</b>
&nbsp;
<b class="pc">&nbsp;        val maintenance = maintenanceRepository.findByIdOrNull(vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Maintenance with id $vehicleId not found&quot;)</b>
<b class="fc">&nbsp;            throw MaintenanceNotFound(&quot;Maintenance not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return maintenance.toDTO()</b>
&nbsp;    }
&nbsp;
&nbsp;    override fun addVehicleMaintenance(vehicleId: Long, maintenance: MaintenanceDTO): MaintenanceDTO {
<b class="fc">&nbsp;        logger.info(&quot;Adding maintenance for vehicle $vehicleId&quot;)</b>
&nbsp;
<b class="pc">&nbsp;        val vehicle = vehicleRepository.findByIdOrNull(vehicleId) ?: run {</b>
<b class="nc">&nbsp;            logger.warn(&quot;Vehicle with id $vehicleId not found&quot;)</b>
<b class="fc">&nbsp;            throw CarModelNotFound(&quot;Vehicle with id: ${vehicleId} was not found&quot;)</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        vehicle.let {</b>
<b class="pc">&nbsp;            if (maintenanceRepository.existsByVehicleAndId(it, maintenance.id) == true) {</b>
<b class="nc">&nbsp;                logger.warn(&quot;Maintenance ${maintenance.id} already exists for vehicle $vehicleId&quot;)</b>
<b class="nc">&nbsp;                throw MainteinanceDuplicate(&quot;This mainteinance on vehicle ${maintenance.vehicleId} already exists&quot;)</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            val savedMaintenance = maintenanceRepository.save(</b>
<b class="fc">&nbsp;                MaintenanceHistory(</b>
<b class="fc">&nbsp;                    maintenance.id,</b>
<b class="fc">&nbsp;                    vehicle,</b>
<b class="fc">&nbsp;                    maintenance.defect,</b>
<b class="fc">&nbsp;                    maintenance.completedMaintenance,</b>
<b class="pc">&nbsp;                    maintenance.date?.let { it1 -&gt; LocalDate.parse(it1) }</b>
&nbsp;                )
&nbsp;            )
&nbsp;
<b class="fc">&nbsp;            logger.info(&quot;Successfully added maintenance for vehicle $vehicleId&quot;)</b>
<b class="fc">&nbsp;            logger.debug(&quot;Added maintenance details: $savedMaintenance&quot;)</b>
&nbsp;
<b class="fc">&nbsp;            return savedMaintenance.toDTO()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // TESTING PURPOSES
&nbsp;    override fun deleteAll() {
<b class="fc">&nbsp;        logger.info(&quot;Deleting all vehicles, maintenances, and notes&quot;)</b>
<b class="fc">&nbsp;        noteRepository.deleteAll()</b>
<b class="fc">&nbsp;        maintenanceRepository.deleteAll()</b>
<b class="fc">&nbsp;        vehicleRepository.deleteAll()</b>
<b class="fc">&nbsp;        logger.info(&quot;Successfully deleted all vehicles, maintenances, and notes&quot;)</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-05-02 00:08</div>
</div>
</body>
</html>
